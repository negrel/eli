#!/usr/bin/env bash

source "$ELI_PATH/lib/log"
source "$ELI_PATH/lib/traps"

if [ $# -eq 0 ]; then
  log_fatal "missing Dockerfile path"
fi

dockerfile="$1"
shift
cd $(dirname "$dockerfile") 2>&1 > /dev/null

log_info "starting to build $dockerfile..."

set -e
buildah bud -f "$(basename $dockerfile)" $@ > >(log_pipe "[BUILDAH] %s") 2>&1
exit_code="$?"
set +e

cd - 2>&1 > /dev/null
if [ "$exit_code" != "0" ]; then
  log_error "build of $dockerfile failed"
  exit $exit_code
fi

log_info "$dockerfile successfully built"